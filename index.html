<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReWear - Sustainable Fashion Exchange</title>
    <style>
        :root{--primary-color:#4CAF50;--secondary-color:#2196F3;--accent-color:#FFC107;--background-color:#f4f7f6;--text-color:#333;--card-bg:#fff;--border-color:#e0e0e0;--error-color:#f44336;--success-color:#4CAF50;--info-color:#2196F3}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:0;background-color:var(--background-color);color:var(--text-color);line-height:1.6;display:flex;flex-direction:column;min-height:100vh}header{background-color:var(--primary-color);color:#fff;padding:15px 25px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,.1)}header h1{margin:0;font-size:1.8em;cursor:pointer}.user-info{display:flex;align-items:center;gap:20px}.user-details{font-size:.95em}.logout-btn{background-color:var(--error-color);color:#fff;padding:8px 15px;border:none;border-radius:5px;cursor:pointer;font-size:.9em;transition:background-color .3s ease}.logout-btn:hover{background-color:#d32f2f}main{flex-grow:1;padding:20px;display:flex;justify-content:center;align-items:flex-start;flex-direction:column;width:100%;box-sizing:border-box}.container{background-color:var(--card-bg);padding:30px 40px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.08);width:100%;max-width:500px;margin:20px auto;box-sizing:border-box}h2{text-align:center;color:var(--primary-color);margin-bottom:25px;font-size:2em}.form-group{margin-bottom:20px}label{display:block;margin-bottom:8px;font-weight:700;color:var(--text-color)}input[type=email],input[type=password],input[type=text],input[type=number],select,textarea{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-size:1em;box-sizing:border-box}input[type=file]{padding:8px 0}textarea{resize:vertical;min-height:80px}.primary-btn,.action-btn{background-color:var(--primary-color);color:#fff;padding:12px 20px;border:none;border-radius:8px;cursor:pointer;font-size:1.1em;width:100%;box-sizing:border-box;transition:background-color .3s ease;display:block;text-align:center}.primary-btn:hover,.action-btn:hover{background-color:#43a047}.secondary-btn{background-color:var(--secondary-color);margin-top:15px}.secondary-btn:hover{background-color:#1976d2}.switch-form{text-align:center;margin-top:20px;font-size:.95em}.switch-form a{color:var(--secondary-color);text-decoration:none;font-weight:700}.switch-form a:hover{text-decoration:underline}.message{padding:12px;border-radius:8px;margin-bottom:20px;font-weight:700;text-align:center;font-size:.95em;display:none}.message.success{background-color:#e8f5e9;color:var(--success-color);border:1px solid var(--success-color)}.message.error{background-color:#ffebee;color:var(--error-color);border:1px solid var(--error-color)}.message.info{background-color:#e3f2fd;color:var(--info-color);border:1px solid var(--info-color)}
    </style>
</head>
<body>
    <header>
        <h1 onclick="checkAuthAndRender()">ReWear</h1>
        <div class="user-info" id="header-user-info" style="display: none;">
            <div class="user-details">
                Hello, <span id="user-display-name"></span>!<br>
                Points: <span id="user-points">0</span>
            </div>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>
    </header>

    <main id="main-content">
        <div id="loading-spinner" style="text-align: center; padding: 50px;">
            <p>Loading...</p>
        </div>
    </main>

    <script>
        // --- Constants ---
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxabb8wIGwsx1aq9RcmSetLhrbwm9yAybRFMBMKPjIOiOQ1HteRJwF9cS-jYIU_ZjNd/exec';
        const SITE_NAME = 'ReWear';

        const mainContent = document.getElementById('main-content');
        const headerUserInfo = document.getElementById('header-user-info');
        const userDisplayNameSpan = document.getElementById('user-display-name');
        const userPointsSpan = document.getElementById('user-points');
        
        function displayMessage(message, type, container) {
            const targetContainer = container || mainContent;
            let messageDiv = targetContainer.querySelector('.message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                targetContainer.prepend(messageDiv);
            }
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
        }

        function clearMessages() {
            document.querySelectorAll('.message').forEach(el => el.style.display = 'none');
        }

        function updateHeaderForAuthenticatedUser(displayName, points) {
            if (displayName) {
                userDisplayNameSpan.textContent = displayName;
                userPointsSpan.textContent = points || 0;
                headerUserInfo.style.display = 'flex';
            } else {
                headerUserInfo.style.display = 'none';
            }
        }
        
        async function apiCall(requestBody) {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    redirect: 'follow'
                });
                return await response.json();
            } catch (error) {
                console.error('API Call Error:', error);
                return { status: 'error', message: 'Network error or script is unavailable.' };
            }
        }

        function showAuthPage() {
            mainContent.innerHTML = `
                <div class="container">
                    <h2>Login to ${SITE_NAME}</h2>
                    <div class="message"></div>
                    <form id="loginForm">
                        <div class="form-group"><label for="email">Email:</label><input type="email" id="email" required></div>
                        <div class="form-group"><label for="password">Password:</label><input type="password" id="password" required></div>
                        <button type="submit" class="primary-btn">Login</button>
                    </form>
                    <div class="switch-form">Don't have an account? <a href="#" onclick="showSignupForm()">Sign Up</a></div>
                </div>`;
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        function showSignupForm() {
            mainContent.innerHTML = `
                <div class="container">
                    <h2>Sign Up for ${SITE_NAME}</h2>
                    <div class="message"></div>
                    <form id="signupForm">
                        <div class="form-group"><label for="displayName">Display Name:</label><input type="text" id="displayName" required></div>
                        <div class="form-group"><label for="email">Email:</label><input type="email" id="email" required></div>
                        <div class="form-group"><label for="password">Password:</label><input type="password" id="password" required minlength="6"></div>
                        <button type="submit" class="primary-btn">Sign Up</button>
                    </form>
                    <div class="switch-form">Already have an account? <a href="#" onclick="showAuthPage()">Login</a></div>
                </div>`;
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
        }

        async function handleLogin(event) {
            event.preventDefault();
            const container = event.target.closest('.container');
            clearMessages();
            displayMessage('Logging in...', 'info', container);

            const requestBody = {
                action: 'login',
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            };
            const data = await apiCall(requestBody);

            if (data.status === 'success') {
                localStorage.setItem('sessionToken', data.data.sessionToken);
                localStorage.setItem('userDisplayName', data.data.displayName);
                localStorage.setItem('userPoints', data.data.points);
                checkAuthAndRender();
            } else {
                displayMessage(data.message, 'error', container);
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            const container = event.target.closest('.container');
            clearMessages();
            displayMessage('Signing up...', 'info', container);
            
            const requestBody = {
                action: 'register',
                displayName: document.getElementById('displayName').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            };
            const data = await apiCall(requestBody);

            if (data.status === 'success') {
                displayMessage('Success! Redirecting to login...', 'success', container);
                setTimeout(showAuthPage, 2000);
            } else {
                displayMessage(data.message, 'error', container);
            }
        }

        function handleLogout() {
            localStorage.clear();
            updateHeaderForAuthenticatedUser(null);
            showAuthPage();
        }

        function renderDashboardPage() {
            mainContent.innerHTML = `<div class="container"><h2>Welcome, ${localStorage.getItem('userDisplayName')}!</h2><p>Your dashboard is ready. You can now add the other pages like 'Add Item' and 'Browse Items'.</p></div>`;
            updateHeaderForAuthenticatedUser(localStorage.getItem('userDisplayName'), localStorage.getItem('userPoints'));
        }

        function checkAuthAndRender() {
            const token = localStorage.getItem('sessionToken');
            if (token) {
                renderDashboardPage();
            } else {
                showAuthPage();
            }
        }
        
        window.addEventListener('load', checkAuthAndRender);
    </script>
</body>
</html>
